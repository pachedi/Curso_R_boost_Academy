---
title: "Introducción a R"
subtitle: "Ejercicios clase 3  Resuelto"
output:
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    #number_sections: true
    theme: lumen
---
## TAREA CLASE 3

````{r results = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(openxlsx)
library(ggplot2)
library(lubridate)
library(plotly)
options(scipen=999) # para quitar la notación científica
```

## 1-Cargar la base de vacunación de CABA.
```{r}
base_caba <- read.csv('https://raw.githubusercontent.com/pachedi/INTRO_R_CS/main/vacunas_caba.csv', encoding = 'UTF-8', fill = TRUE) %>% 
  select(-(1))

base_caba <- base_caba %>% 
  mutate(FECHA_ADMINISTRACION = ymd(FECHA_ADMINISTRACION)) %>% # cambiamos clase fecha
  select(-(8)) # eliminamos la columna que tiene el índice

head(base_caba)
```

## 2- Crear una columna llamada "total_vacunas" que sea la suma de las 3 dosis en cada línea
```{r}
base_caba <- base_caba %>% 
  mutate(total_vacunas = DOSIS_1+DOSIS_2+DOSIS_3)

base_caba[is.na(base_caba)] <- 0  # reemplazamos los valores faltantes por 0

head(base_caba)
```
  
## 3-Crear una nueva tabla con una variable resumen que indique la cantidad total de vacunas por grupo etario
```{r}
edades <- base_caba %>% 
  group_by(GRUPO_ETARIO,GENERO) %>% 
  summarise(Total = sum(total_vacunas))

head(edades)
```

## 4- Crear un gráfico de barras por grupo etario dividido por género que exprese la cantidad de vacunas aplicadas:
```{r}
ggplot(edades)+
  aes(x = GRUPO_ETARIO, y = Total, fill = GENERO)+
  geom_col(stat= 'identity', color = 'black')+
  labs(title = 'Cantidad de vacunas aplicadas por rango etario en CABA',
       x= 'Grupo etario', 
       caption = 'Fuente: Datos abiertos de la CABA')+
  theme_minimal()+
  scale_fill_brewer(palette = "Set1")

```
  
## 5-Crear un gráfico de barras que agrupe por tipo de vacuna y tipo de dosis.
Agrupamos por vacuna y sumamos diferenciando por dosis.
```{r}
vacunas <- base_caba %>% 
  group_by(VACUNA) %>% 
  summarise(dosis1 = sum(DOSIS_1),
            dosis2 = sum(DOSIS_2),
            dosis3 = sum(DOSIS_3, na.rm = TRUE)) # na.rm sirve para quitar los valores NA (not available)

vacunas$VACUNA[5] = 'CANSINO' # reemplazamos el nombre de la vacuna por uno más corto
vacunas$VACUNA[6] = 'PFIZER'  # idem

vacunas <- vacunas %>% 
  pivot_longer(., cols = 2:4, names_to = 'Dosis', values_to = 'Cantidad') # Pasamos las columnas de dosis como filas para poder graficar subdividiente

head(vacunas)

```
Graficamos:
```{r}
ggplot(data = vacunas, aes(x= reorder(VACUNA, -Cantidad), y= Cantidad, fill= Dosis))+
  geom_bar(stat='identity', position = position_dodge(), color = 'black')+
  labs(title = 'Tipos de vacunas aplicadas en CABA',
       subtitle = 'Discriminado por dosis',
       caption = 'Fuente: Datos abiertos de CABA 2021-2022',
       x = 'Vacuna')+
  theme_minimal()+
  scale_fill_brewer(palette = "Set2")
```
  
## 6- Crear un gráfico de línea que muestre la cantidad de vacunas aplicadas por día y por género con etiqueta mensual.
pista: agrupar por día y genero. De la base agrupada filtrar por genero.
```{r}
por_dia <- base_caba %>% 
  group_by(FECHA_ADMINISTRACION, GENERO) %>% 
  summarise(total_vacunas = sum(total_vacunas))

FEM <- por_dia %>% 
  filter(GENERO == 'F')

MASC <- por_dia %>% 
  filter(GENERO == 'M')

ggplot(por_dia, aes(x = FECHA_ADMINISTRACION, y = total_vacunas))+
  geom_line(data =FEM, aes(y= total_vacunas, colour = 'Mujeres'))+
  geom_line(data =MASC, aes(y= total_vacunas, colour = 'Varones'))+
  scale_x_date(date_breaks = '1 month')+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = 'Cantidad de vacunas aplicadas por día por género en CABA',
       x = 'Fecha administración', y='Cantidad de vacunas aplicadas',
       col = 'Género')


```

## 7-Realizar un gráfico de la cantidad de vacunas aplicadas por día por marca (pfizer, moderna, etc..)
Pista: utilizar la función facet_wrap() para crear los gráficos por marca.
```{r}
tipo_vacuna <- base_caba %>% 
  group_by(FECHA_ADMINISTRACION, VACUNA) %>% 
  summarise(total_vacunas = sum(total_vacunas)) 


ggplot(tipo_vacuna, aes(x = FECHA_ADMINISTRACION, y = total_vacunas))+
  geom_line(data =tipo_vacuna, aes(y = total_vacunas))+
  facet_wrap(~VACUNA)+
  scale_x_date(breaks = '3 month')+
  theme(axis.text.x = element_text(angle = 90))
            
            
```

## 8- Realizar un gráfico de barras que exprese la proporción de vacunas aplicadas agrupado por rango etario.
```{r}
rangos <- base_caba %>% 
  group_by(GRUPO_ETARIO) %>% 
  summarise(total = sum(total_vacunas), # total de vacunas aplicadas
            varones_n = sum(total_vacunas[GENERO == 'M']), # total aplicadas a varones
            mujeres_n = sum(total_vacunas[GENERO =='F']), # total aplicadas a mujeres
            varones = varones_n / total * 100, # proporcion a varones
            mujeres = mujeres_n / total * 100) %>%  # proporcion a mujeres
  mutate(varones = as.integer(varones), # convertirmos el valor en entero
         mujeres = as.integer(mujeres)) %>%  # idem
  select(GRUPO_ETARIO, varones, mujeres) %>% # seleccionamos las columnas que nos interesan
  pivot_longer(., cols = 2:3, names_to = 'GENERO', values_to = 'Porcentaje') # Pasamos el género como fila

head(rangos)

```
```{r}
ggplot(rangos) +
  aes(x = GRUPO_ETARIO, y = Porcentaje , fill = GENERO)+
  geom_bar(stat = 'identity', color = 'black',
           position = position_dodge())+
  coord_flip()

```
  
## 9-Realizar un gráfico de barras que presente el total de vacunas aplicadas en 2021 y un gráfico de línea que presente el promedio semanal de aplicación de vacunas.
```{r}

x_por_semana <- base_caba %>% 
  mutate(semana = week(as.Date(FECHA_ADMINISTRACION)), # creamos columna semana
         año = year(FECHA_ADMINISTRACION)) # creamos columna año

x_por_semana_b <- x_por_semana %>% 
  group_by(año, semana) %>% 
  summarise(total = sum(total_vacunas), 
            promedio  = total / 7) %>%  # creamos el promedio por semana
 mutate(promedio = as.integer(promedio)) # pasamos el promedio a número entero

veintiuno <- x_por_semana_b %>% 
  filter(año == 2021)

  head(veintiuno)
```
  
Graficamos:
```{r}
ggplot(data  = veintiuno)+
  aes(x = semana, y = total) +
  geom_col(aes(y = total, x = semana, fill = total), color = 'black')+
  geom_line(data = veintiuno,aes(x = semana,y = promedio, color = 'Promedio semanal'),
            size = 1)+
  scale_fill_gradient(low = 'white', high = 'blue', name ='Total')+
  labs(title = 'Vacunación semanal durante 2021 en CABA',
       caption = 'Fuente: Datos abiertos CABA',
       y ='Total', x  = 'Nro de semana', color = 'Línea')+
  scale_x_continuous(breaks = c(10,20,30,40,50))+
  theme_minimal()
```
  
## 10- Convertirlo en gráfico interactivo
```{r}

my_plot <- ggplot(data  = veintiuno)+
  aes(x = semana, y = total) +
  geom_col(aes(y = total, x = semana, fill = total), color = 'black')+
  geom_line(data = veintiuno,aes(x = semana,y = promedio, color = 'Promedio semanal'),
            size = 1)+
  scale_fill_gradient(low = 'white', high = 'blue', name ='Total')+
  labs(title = 'Vacunación semanal durante 2021 en CABA',
       caption = 'Fuente: Datos abiertos CABA',
       y ='Total', x  = 'Nro de semana', color = 'Línea')+
  scale_x_continuous(breaks = c(10,20,30,40,50))+
  theme_minimal()

ggplotly(my_plot, width = 700, height = 500)

```
## Bonus: Crear un gráfico de barras con la cantidad de vacunas aplicadas por día y un gráfico de líneas con el promedio semanal durante 2021.
a-Filtramos por año 2021 y agrupamos por día.
Creamos una nueva columna con el total por día.
```{r}
x_por_semana_2 <- x_por_semana %>% 
  filter(año == 2021) %>% 
  group_by(FECHA_ADMINISTRACION) %>% 
  summarise(total = sum(total_vacunas))

head(x_por_semana_2)

```
b-Creamos otra tabla agrupando por semana y obteniendo el promedio por cada semana.
-Convertimos en fecha el número de semana.
```{r}

x_por_semana_3 <- x_por_semana %>%
  filter(año == 2021) %>% 
  group_by(semana) %>% 
  summarise(total = sum(total_vacunas),
            promedio = total / 7) %>% 
  mutate(promedio = as.integer(promedio))

x_por_semana_3 <-x_por_semana_3 %>% 
  mutate(fecha =as.Date(paste(2021, x_por_semana_3$semana, 01, sep="-"), "%Y-%U-%u"))


head(x_por_semana_3)
```
Graficamos:
```{r}
ggplot(x_por_semana_2, aes(x = FECHA_ADMINISTRACION, y = total))+
  geom_col(data = x_por_semana_2, aes(x = FECHA_ADMINISTRACION, y= total, fill =total))+
  geom_line(data = x_por_semana_3, aes(x =fecha, y = promedio,color = 'promedio'),
                                       size = 1)+
  labs(title = 'Cantidad de vacunas aplicadas por día en CABA',
       x= 'Fecha', y='Cantidad', col = 'Por semana')+
  scale_fill_gradient(low = 'dark blue',high = 'light blue', name = 'Cantidad de aplicaciones')+
  scale_color_manual(values="#CC6666")+
  theme_minimal()
  

```
Hagámoslo interactivo:
```{r}
mi_plot <- ggplot(x_por_semana_2, aes(x = FECHA_ADMINISTRACION, y = total))+
  geom_col(data = x_por_semana_2, aes(x = FECHA_ADMINISTRACION, y= total, fill =total))+
  geom_line(data = x_por_semana_3, aes(x =fecha, y = promedio,color = 'promedio'),
                                       size = 1)+
  geom_point(data = x_por_semana_3, aes(x =fecha, y = promedio), color = 'red')+
  labs(title = 'Cantidad de vacunas aplicadas por día en CABA',
       x= 'Fecha', y='Cantidad', col = 'Por semana')+
  scale_color_manual(values="#CC6666")+
  theme_minimal()

ggplotly(mi_plot, width = 700, height = 500)

```

```{r}


```