---
title: "Introducción a R"
subtitle: "Ejercicios clase 3  Resuelto"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    #number_sections: true
    theme: lumen
---
## TAREA CLASE 3

````{r results = FALSE, warning = FALSE, message = FALSE}
library(tidyverse)
library(openxlsx)
library(ggplot2)
library(lubridate)
library(plotly)
options(scipen=999) # para quitar la notación científica
```

## 1-Cargar la base de vacunación de CABA.
```{r echo=FALSE , warning = FALSE, message = FALSE} 
base_caba <- read.csv('https://raw.githubusercontent.com/pachedi/INTRO_R_CS/main/vacunas_caba.csv', encoding = 'UTF-8', fill = TRUE) %>% 
  select(-(1))

base_caba <- base_caba %>% 
  mutate(FECHA_ADMINISTRACION = ymd(FECHA_ADMINISTRACION)) %>% 
  select(-(8))
```

## 2- Crear una columna llamada "total_vacunas" que sea la suma de las 3 dosis en cada línea
```{r echo=FALSE , warning = FALSE}
base_caba <- base_caba %>% 
  mutate(total_vacunas = DOSIS_1+DOSIS_2+DOSIS_3)

base_caba[is.na(base_caba)] <- 0
```
  
## 3-Crear una nueva tabla con una variable resumen que indique la cantidad total de vacunas por grupo etario
```{r echo=FALSE , warning = FALSE}
edades <- base_caba %>% 
  group_by(GRUPO_ETARIO,GENERO) %>% 
  summarise(Total = sum(total_vacunas))

```

## 4- Crear un gráfico de barras por grupo etario dividido por género que exprese la cantidad de vacunas aplicadas:
```{r echo=FALSE , warning = FALSE}
ggplot(edades)+
  aes(x = GRUPO_ETARIO, y = Total, fill = GENERO)+
  geom_bar(stat= 'identity', color = 'black')+
  labs(title = 'Cantidad de vacunas aplicadas por rango etario en CABA',
       x= 'Grupo etario', 
       caption = 'Fuente: Datos abiertos de la CABA')+
  theme_minimal()+
  scale_fill_brewer(palette = "Set1")

```
  
## 5-Crear un gráfico de barras que agrupe por tipo de vacuna y tipo de dosis.
Agrupamos por vacuna y sumamos diferenciando por dosis.
```{r echo=FALSE , warning = FALSE}
vacunas <- base_caba %>% 
  group_by(VACUNA) %>% 
  summarise(dosis1 = sum(DOSIS_1),
            dosis2 = sum(DOSIS_2),
            dosis3 = sum(DOSIS_3, na.rm = TRUE))

vacunas$VACUNA[5] = 'CANSINO'
vacunas$VACUNA[6] = 'PFIZER'

vacunas <- vacunas %>% 
  pivot_longer(., cols = 2:4, names_to = 'Dosis', values_to = 'Cantidad')

```
Graficamos:
```{r echo=FALSE , warning = FALSE , message = FALSE} 
ggplot(data = vacunas, aes(x= reorder(VACUNA, -Cantidad), y= Cantidad, fill= Dosis))+
  geom_bar(stat='identity', position = position_dodge(), color = 'black')+
  labs(title = 'Tipos de vacunas aplicadas en CABA',
       subtitle = 'Discriminado por dosis',
       caption = 'Fuente: Datos abiertos de CABA 2021-2022',
       x = 'Vacuna')+
  theme_minimal()+
  scale_fill_brewer(palette = "Set2")
```
  
## 6- Crear un gráfico de línea que muestre la cantidad de vacunas aplicadas por día y por género con etiqueta mensual.
pista: agrupar por día y genero. De la base agrupada filtrar por genero.
```{r echo=FALSE , warning = FALSE}
por_dia <- base_caba %>% 
  group_by(FECHA_ADMINISTRACION, GENERO) %>% 
  summarise(total_vacunas = sum(total_vacunas))

FEM <- por_dia %>% 
  filter(GENERO == 'F')

MASC <- por_dia %>% 
  filter(GENERO == 'M')

ggplot(por_dia, aes(x = FECHA_ADMINISTRACION, y = total_vacunas))+
  geom_line(data =FEM, aes(y= total_vacunas, colour = 'Mujeres'))+
  geom_line(data =MASC, aes(y= total_vacunas, colour = 'Varones'))+
  scale_x_date(date_breaks = '1 month')+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90))+
  labs(title = 'Cantidad de vacunas aplicadas por día por género en CABA',
       x = 'Fecha administración', y='Cantidad de vacunas aplicadas',
       col = 'Género')


```

## 7-Realizar un gráfico de la cantidad de vacunas aplicadas por día por marca (pfizer, moderna, etc..)  
Pista: utilizar la función facet_wrap() para crear los gráficos por marca.  

```{r echo=FALSE , warning = FALSE , message = FALSE}
tipo_vacuna <- base_caba %>% 
  group_by(FECHA_ADMINISTRACION, VACUNA) %>% 
  summarise(total_vacunas = sum(total_vacunas))


ggplot(tipo_vacuna, aes(x = FECHA_ADMINISTRACION, y = total_vacunas))+
  geom_line(data =tipo_vacuna, aes(y = total_vacunas))+
  facet_wrap(~VACUNA)+
  scale_x_date(breaks = '3 month')+
  theme(axis.text.x = element_text(angle = 90))
            
            
```

## 8- Realizar un gráfico de barras que exprese la proporción de vacunas aplicadas agrupado por rango etario.
```{r echo=FALSE , warning = FALSE}
rangos <- base_caba %>% 
  group_by(GRUPO_ETARIO) %>% 
  summarise(total = sum(total_vacunas),
            varones_n = sum(total_vacunas[GENERO == 'M']),
            mujeres_n = sum(total_vacunas[GENERO =='F']),
            varones = varones_n / total * 100,
            mujeres = mujeres_n / total * 100) %>% 
  mutate(varones = as.integer(varones), 
         mujeres = as.integer(mujeres)) %>% 
  select(GRUPO_ETARIO, varones, mujeres) %>% 
  pivot_longer(., cols = 2:3, names_to = 'GENERO', values_to = 'Porcentaje')

ggplot(rangos) +
  aes(x = GRUPO_ETARIO, y = Porcentaje , fill = GENERO)+
  geom_bar(stat = 'identity', color = 'black',
           position = position_dodge())+
  coord_flip()


```
  